#!/usr/bin/env bash

# Enable strict error handling and debug output
set -euxo pipefail

# Step 1: Ensure system is up-to-date
echo "Updating system..."
mkdir -p /var/lib/apt/lists/partial  # Create the missing directory for apt
apt-get update -y
apt-get upgrade -y
apt-get dist-upgrade -y

# Step 2: Install required dependencies
echo "Installing required dependencies..."
apt-get install -y \
  build-essential \
  python3-dev \
  python3-pip \
  python3-venv \
  nodejs \
  npm \
  curl \
  unzip \
  libssl-dev \
  libcurl4-openssl-dev \
  libjpeg-dev \
  liblcms2-dev \
  libblas-dev \
  liblapack-dev \
  gfortran \
  git \
  jq

# Step 3: Clean up unnecessary files (optional)
echo "Cleaning up unnecessary files..."
apt-get autoremove -y
apt-get clean -y

# Step 4: Ensure proper file permissions
echo "Fixing file permissions..."
chown -R $(whoami):$(whoami) /var/lib/apt/lists

# Step 5: Install JupyterLab and necessary extensions
echo "Installing JupyterLab and extensions..."
pip install jupyterlab
jupyter labextension install \
  jupyterlab-plotly \
  @almond-sh/scalafmt \
  @almond-sh/jupyterlab_variableinspector || echo "Failed to install JupyterLab extensions"

# Step 6: Rebuild JupyterLab with debugging
echo "Rebuilding JupyterLab..."
jupyter lab build --dev-build=False --minimize=False || echo "JupyterLab build failed"

# Step 7: Install Scala kernels for different versions
echo "Installing Scala kernels..."

# Install Scala 2.12
./cs launch "almond:0.14.0" --scala 2.12.12 -- \
  --install \
  --id scala212 \
  --display-name "Scala (2.12)" \
  --env "JAVA_OPTS=-XX:MaxRAMPercentage=80.0" \
  --variable-inspector \
  </dev/null 2>&1 | grep -v '^Download'

# Install Scala 2.11
SCALA_VERSION=2.11.12
./cs bootstrap \
  -r jitpack \
  -i user -I user:sh.almond:scala-kernel-api_$SCALA_VERSION:0.14.0 \
  sh.almond:scala-kernel_$SCALA_VERSION:0.14.0 \
  --sources --default=true \
  -o almond-scala-2.11 \
  </dev/null 2>&1 | grep -v '^Download'

./almond-scala-2.11 --install --id scala211 --display-name "Scala (2.11)" \
  --command "java -XX:MaxRAMPercentage=80.0 -jar almond-scala-2.11 --id scala211 --display-name 'Scala (2.11)'" \
  --copy-launcher \
  --metabrowse
rm -f almond-scala-2.11

# Step 8: Additional setup (if necessary)
echo "Performing any additional setup tasks..."
# Add any other necessary steps here, like environment variables or further configuration

echo "Setup completed successfully!"
