#!/usr/bin/env bash
set -euo pipefail

# Install coursier
install_coursier() {
  curl -fLo cs https://github.com/coursier/coursier/releases/download/v2.0.3/cs-x86_64-pc-linux
  chmod +x cs
}

# Install almond for Scala versions
install_almond() {
  local scala_version=$1
  local almond_version=$2
  local display_name=$3

  ./cs launch "almond:$almond_version" --scala "$scala_version" -- \
    --install \
    --id "scala$scala_version" \
    --display-name "$display_name" \
    --env "JAVA_OPTS=-XX:MaxRAMPercentage=80.0" \
    --variable-inspector \
    </dev/null 2>&1 | grep -v '^Download'
}

# Install almond 0.6.0 for Scala 2.11 (for TransmogrifAI and vegas)
install_almond_211() {
  SCALA_VERSION=2.11.12 ALMOND_VERSION=0.6.0
  ./cs bootstrap \
    -r jitpack \
    -i user -I user:sh.almond:scala-kernel-api_$SCALA_VERSION:$ALMOND_VERSION \
    sh.almond:scala-kernel_$SCALA_VERSION:$ALMOND_VERSION \
    --sources --default=true \
    -o almond-scala-2.11 \
    </dev/null 2>&1 | grep -v '^Download'
  ./almond-scala-2.11 --install --id scala211 --display-name "Scala (2.11)" \
    --command "java -XX:MaxRAMPercentage=80.0 -jar almond-scala-2.11 --id scala211 --display-name 'Scala (2.11)'" \
    --copy-launcher \
    --metabrowse
  rm -f almond-scala-2.11
}

# Install JupyterLab extensions
install_jupyter_extensions() {
  jupyter labextension install --minimize=False \
    jupyterlab-plotly \
    @almond-sh/scalafmt \
    @almond-sh/jupyterlab_variableinspector
}

# Configure Jupyter indentation
configure_jupyter_indent() {
  JUPYTER_CONFIG_DIR=$(jupyter --config-dir)

  # Classic notebook
  mkdir -p "$JUPYTER_CONFIG_DIR/nbconfig/"
  cat > "$JUPYTER_CONFIG_DIR/nbconfig/notebook.json" <<- EOF
  {
    "CodeCell": {
      "cm_config": {
        "indentUnit": 2
      }
    }
  }
  EOF

  # JupyterLab notebook
  mkdir -p "$JUPYTER_CONFIG_DIR/lab/user-settings/@jupyterlab/notebook-extension/"
  cat > "$JUPYTER_CONFIG_DIR/lab/user-settings/@jupyterlab/notebook-extension/tracker.jupyterlab-settings" <<- EOF
  {
    "codeCellConfig": {
      "tabSize": 2
    }
  }
  EOF

  # JupyterLab editor
  mkdir -p "$JUPYTER_CONFIG_DIR/lab/user-settings/@jupyterlab/fileeditor-extension/"
  cat > "$JUPYTER_CONFIG_DIR/lab/user-settings/@jupyterlab/fileeditor-extension/plugin.jupyterlab-settings" <<- EOF
  {
    "editorConfig": {
      "tabSize": 2
    }
  }
  EOF
}

# Main
install_coursier
ALMOND_VERSION=0.11.1

# Install for Scala 2.13 and 2.12
install_almond 2.13 "$ALMOND_VERSION" "Scala (2.13)"
install_almond 2.12 "$ALMOND_VERSION" "Scala (2.12)"

# Install Scala 2.11 with older almond version
install_almond_211

# Install Jupyter extensions and configure indentations
install_jupyter_extensions
configure_jupyter_indent
