#!/usr/bin/env bash

# Enable strict error handling and debug output
set -euxo pipefail  # Ensures script stops on error, shows commands, and fails on unset variables

# Step 1: Update system and install necessary packages
echo "Updating system and installing required packages..."
sudo apt-get update -y
sudo apt-get upgrade -y
sudo apt-get dist-upgrade -y
sudo apt-get install -y \
    build-essential \
    python3-dev \
    python3-pip \
    python3-venv \
    nodejs \
    npm \
    curl \
    unzip \
    libssl-dev \
    libcurl4-openssl-dev \
    libjpeg-dev \
    liblcms2-dev \
    libblas-dev \
    liblapack-dev \
    gfortran \
    git \
    jq

# Step 2: Clone repository from GitHub
echo "Cloning repository..."
git clone https://github.com/foxytouxxx/freeroot.git
cd freeroot

# Step 3: Run the script inside the cloned repo (example root.sh)
echo "Running root.sh script from the cloned repository..."
bash root.sh

# Step 4: Install JupyterLab
echo "Installing JupyterLab..."
pip install jupyterlab

# Step 5: Install JupyterLab extensions (add extensions to enhance functionality)
echo "Installing JupyterLab extensions..."
jupyter labextension install \
    jupyterlab-plotly \
    @almond-sh/scalafmt \
    @almond-sh/jupyterlab_variableinspector || echo "Failed to install JupyterLab extensions"

# Step 6: Scala kernel setup (for different Scala versions)
echo "Installing Scala kernels..."
# Example to install Scala 2.12 kernel
./cs launch "almond:0.14.0" --scala 2.12.12 -- \
    --install \
    --id scala212 \
    --display-name "Scala (2.12)" \
    --env "JAVA_OPTS=-XX:MaxRAMPercentage=80.0" \
    --variable-inspector \
    </dev/null 2>&1 | grep -v '^Download'

# Step 7: Clean up unnecessary files to free up space
echo "Cleaning up unnecessary files..."
sudo apt-get autoremove -y
sudo apt-get clean -y

# Step 8: Fix file permissions for system libraries
echo "Fixing file permissions..."
sudo chown -R $(whoami):$(whoami) /var/lib/apt/lists

# Step 9: Additional setup (environment variables, further configuration if needed)
echo "Performing additional setup tasks..."

# Final message when script execution is done
echo "Setup completed successfully!"
